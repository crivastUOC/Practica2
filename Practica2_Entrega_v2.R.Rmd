---
title: "Tipologia i Cicle de vida de les dades"
subtitle: "Pr√†ctica 2: Neteja i validaci√≥ de les dades"
author: "Pol Casellas, Carlos Rivas"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
    
---

# PRACTICA 2 - NETEJA I VALIDACIO DE DADES
# POL CASELLAS i CARLES RIVAS
# ---------------------------------------------------------------------
# ---------------------------------------------------------------------

# 1. Descripci√≥ del dataset. Perqu√® √©s important i quina pregunta/problema pret√©n respondre?

El dataset original √©s el dataset de dades dels passatgers del Tit√†nic, que s‚Äôutilitza en la competici√≥  ‚ÄúTitanic: Machine Learning from Disaster‚Äù. Esta composat per dos fitxers, un de training (train.csv) amb 891 registres i un de test (test.csv) amb 418 registres. L‚Äôobjectiu del dataset de la competici√≥ es generar un model de ML per predir la superviv√®ncia a l‚Äôenfonsament del vaixell, en base a la informaci√≥ disponible dels passatgers.

El diccionari de dades del dataset original √©s :

<table border=1>

<th> Variable </th>
<th> Descripci√≥ </th>
<th> Tipus </th>
<th> Valors </th>

<tr>
<td>PassangerId</td>
<td>Identificador de passatger</td>
<td>Enter</td>
<td></td>
</tr>

<tr>
<td>Survival</td>
<td>Identificador de superviv√®ncia</td>
<td>Factor</td>
<td>0 = No, 1 = Yes</td>
</tr>

<tr>
<td>Pclass</td>
<td>Classe del passatge	</td>
<td>Factor</td>
<td>1 = 1a, 2 = 2ona, 3 = 3¬™ </td>
</tr>

<tr>
<td>Name</td>
<td>Nom del passatger</td>
<td>Text</td>
<td></td>
</tr>

<tr>
<td>Sex</td>
<td>Sexe</td>
<td>Factor</td>
<td>1 = male, 2 = female</td>
<td></td>
</tr>
<tr>
<td>Age</td>
<td>Edat en anys</td>
<td>Nombre</td>
<td></td>
</tr>
<tr>
<td>Sibsp</td>
<td>Nombre de germans i dones embarcats</td>
<td>Enter	</td>
<td></td>
</tr>
<tr>
<td>Parch</td>
<td>Nombre de pares i fills embarcats</td>
<td>Enter</td>
<td></td>
</tr>	
<tr>
<td>Ticket</td>
<td>Nombre de Ticket </td>
<td>Text</td>
<td></td>
</tr>
<tr>
<td>Fare</td>
<td>Tarifa del passatge</td>
<td>Nombre</td>
<td></td>
</tr>
<tr>
<td>Cabin</td>
<td>Nombre de cabina</td>
<td>Text</td>
<td></td>
</tr>
<tr>
<td>Embarked</td>
<td>Port d‚ÄôEmbarcament</td>
<td>Factor</td>
<td>C = Cherbourg 
Q = Queenstown 
S = Southampton</td>
</tr>

</table>

# 2. Integraci√≥ i selecci√≥ de les dades d‚Äôinter√®s a analitzar.

Es disposa de 2 fitxers, un fitxer d‚Äôentrenament (que disposa de les dades de superviv√®ncia) i un fitxer de test (sense les dades de superviv√®ncia). Es llegeixen les dades i s‚Äôintegren en un √∫nic dataset.  


```{r, message=FALSE}
library('dplyr')
dades <- bind_rows(read.csv('train.csv', stringsAsFactors = F), read.csv('test.csv', stringsAsFactors = F))
```

Es crea un dataset que integra els dos fitxers anomenat dades. La comanda dim(dades) mostra el nombre d‚Äôobservacions i atributs de la mostra, que en aquest cas s√≥n 1309 observacions i 12 atributs. El camp **Survived** nom√©s est√† informat per les entrades del fitxer d‚Äôentrenament (fins la posici√≥ 891). En la resta d‚Äôentrades, el valor en N.A.

```{r, message=FALSE}
dim (dades)
```

La comanda str(dades) presenta de forma compacta l‚Äôestructura interna del dataset. 

```{r, message=FALSE}
str(dades)
```


Amb la comanda 

```{r, message=FALSE}
factors<-c('Sex','Embarked')
dades[factors] <- lapply(dades[factors], function(x) as.factor(x))
```

s‚Äôindica al dataset que els camps **Pclass**, **Sex** i **Embarked** s√≥n factors. Al aplicar de nou la funci√≥ str(dades) es pot observar que ara es consideren factors i es mostren els possibles valors que admeten.

```{r, message=FALSE}
str(dades)
```

La comanda summary(dades) mostra una visi√≥ general dels atributs i en el cas de factors, es presenten els valors possibles i el nombre d‚Äôocurr√®ncies per cada valor. A m√©s, es pot observar que hi ha diversos valors mal informats o buits. 

```{r, message=FALSE}
summary (dades)
```

# 3. Neteja de les dades.

## 3.1 Les dades contenen zeros o elements buits? Com gestionaries aquests casos?

Es pot observar que hi ha 418 valors no informats de Survived que corresponen als valors del fitxer de test, 263 registres no presents a **Age**, 1 registre  que no informa el **Fare** i 2 registres que no indiquen el camp Embarked. Addicionalment hi ha diversos registres de **Fare** amb valor 0. Es procedeix a aplicar diverses t√®cniques per completar aquestes dades. 

-	Per intentar determinar el valor de la tarifa (**Fare**) que manca, el primer que es fa √©s identificar el registre mal informat

```{r,message=FALSE}
IdNoFare <- dades$PassengerId[is.na(dades$Fare)]
dades[IdNoFare,]
```

S‚Äôobserva que es tracta d‚Äôun passatger de classe 3 i que va embarcar a ‚ÄòS‚Äô. Es calcula el preu mitja de la tarifa d‚Äôaquest tipus de clients i s‚Äôassigna a la tarifa del passatger no informat. El c√†lcul de la mitjana no t√© en compte els valors NA (par√†metre na.rm = TRUE)


```{r,message=FALSE}
dades$Fare[is.na(dades$Fare)] <- median(dades[dades$Pclass == '3' & dades$Embarked == 'S', ]$Fare, na.rm = TRUE)
dades[IdNoFare,]
```

El valor assignat √©s 8,05 $

-	Per intentar determinar el valor de l‚ÄôEmbarked que manca, el primer que es fa √©s identificar els registres mal informats

```{r,message=FALSE}
IdNoEmbarked <- dades$PassengerId[dades$Embarked == '']
dades[IdNoEmbarked,]
```

S‚Äôobserva que es tracta de passatgers de classe 1 amb una tarifa de 80 $. Per determinar el port d‚Äôembarcament es calcula la tarifa mitjana per a la classe 1, per cada tipus d‚Äôembarcament possible.

```{r,message=FALSE}
median(dades[dades$Pclass == '1' & dades$Embarked == 'S', ]$Fare, na.rm = TRUE)
median(dades[dades$Pclass == '1' & dades$Embarked == 'Q', ]$Fare, na.rm = TRUE)
median(dades[dades$Pclass == '1' & dades$Embarked == 'C', ]$Fare, na.rm = TRUE)
```

S‚Äôobserva que la tarifa mitjana m√©s propera a la dels registres no informats √©s 76,73 $ corresponent a l‚Äôembarcament ‚ÄòC‚Äô. S‚Äôassigna aquest valor als registres mal informats.

```{r,message=FALSE}
dades$Embarked[c(IdNoEmbarked)] <- 'C'
```

-	Donat que el nombre de valors **Age** no informats √©s elevat, la opci√≥ d‚Äôesborrar aquests valors suposaria la p√®rdua de molts registres que si contenen altres valors i que √©s interessant conservar. Per aquest motiu, s‚Äôutilitzar√† la llibreria mice (Multivariate Imputations by Chained Equations) que implementa un m√®tode per tractar valors no informats, creant m√∫ltiples imputacions per dades no informades multivariable. Cada variable incompleta es pot imputar per un model separat, permetent la imputaci√≥ de barreges de dades de diversos tipus (categ√≤riques, continues, binaries, ...) i mantenir la coher√®ncia entre les imputacions mitjan√ßant la implantaci√≥ passiva. 

S‚Äôaplica la funci√≥ mice a un subconjunt dels camps del dataset, no es contemplen els camps **PassengerId**, **Name**, **Ticket**, **Cabin**, **Survived** perqu√® no aporten res al model i es simplifiquen els c√†lculs

```{r,message=FALSE}
library('mice')
library('randomForest')
set.seed(1000) 
dadesAge <- complete(mice(dades[, !names(dades) %in% c('PassengerId','Name', 'Ticket', 'Cabin', 'Survived')], method='rf'))
```

Mitjan√ßant la comparaci√≥ visual de plots sobre l‚Äô**Age** original i el estimat, es pot verificar que la assignaci√≥ de les edats no informades no introdueix biaixos en les dades. 

```{r,message=FALSE}
par(mfrow=c(1,2))
hist(dades$Age, freq=F, main='Age: Original', col='red', ylim=c(0,0.05))
hist(dadesAge$Age, freq=F, main='Age: Estimat', col='blue', ylim=c(0,0.05))
```

```{r,message=FALSE}
dades$Age <- dadesAge$Age 
summary (dades)
```

-	En el camp **Fare** s‚Äôobserven diversos valors a 0 que es considera un valor fals, que correspon a valors no informats. Per estimar-los s‚Äôutilitza l‚Äôalgoritme kNN. En primer lloc es substitueix els valors 0 per NA, ja que l‚Äôalgoritme nom√©s estima els valors NA del dataset. A continuaci√≥ s‚Äôaplica l‚Äôalgoritme i s‚Äôobtenen valors pels valors no informats de **Fare**.

```{r,message=FALSE}
# Els valors 0 de Fare es converteixen en NA i es dedueixen amb l'algoritme KNN
dades$Fare[dades$Fare == 0] <- NA

# Es Comprova si hi ha NA,s a Fare
sapply(dades, function(x) sum(is.na(x)))
```

S‚Äôobserva que al **Fare** hi ha 17 registres no informats.

```{r,message=FALSE}
library(VIM)

# S'aplica l'algoritme kNN
dades.kNN <- kNN(dades[, !names(dades) %in% c('PassengerId','Name', 'Ticket', 'Cabin', 'Survived')])

# Es comprova si hi ha NA,s a Fare estimat
sapply(dades.kNN, function(x) sum(is.na(x)))

# Es comprova si hi ha zeros a Fare estimat
length(dades.kNN$Fare[dades.kNN$Fare == 0])

# S'assignen els valors de Fare estimats amb kNN al dataset original
dades$Fare = dades.kNN$Fare
```

-	Per millorar el dataset es planteja la creaci√≥ de nous camps a partir de les dades disponibles :

En primer lloc es crea el camp **TamanyFamilia** format a partir de la suma dels camps **SibSp** i **Parch** (c√≤njuges, germans, pares i fills) m√©s el propi passatger.

```{r,message=FALSE}
# Creaci√≥ del camp TamanyFamilia
dades$TamanyFamilia <- dades$SibSp + dades$Parch + 1
```

A partir d‚Äôaquest camp es crea el camp **TipusFamilia**, de tipus factor, format a partir de rangs de nombre de membres de la fam√≠lia embarcats.

```{r,message=FALSE}
# Creaci√≥ del camp TipusFamilia
dades$TipusFamilia[dades$TamanyFamilia == 1] <- 'solitari'
dades$TipusFamilia[dades$TamanyFamilia < 5 & dades$TamanyFamilia > 1] <- 'petita'
dades$TipusFamilia[dades$TamanyFamilia > 4] <- 'nombrosa'

# Conversi√≥ a factor
dades$TipusFamilia <- as.factor(dades$TipusFamilia)
```

Tamb√© a partir del camp Age es crea el camp **TipusEdat**, de tipus factor, format a partir de rangs d‚Äôedats.

```{r,message=FALSE}
# Es crea el camp TipusEdat en funci√≥ de franges d'edat i es converteix en factor

dades$TipusEdat[dades$Age < 18] <- 'Menor' 
dades$TipusEdat[dades$Age >= 18 & dades$Age <= 65] <- 'Adult'
dades$TipusEdat[dades$Age > 65] <- 'Anci√†'
dades$TipusEdat <- as.factor(dades$TipusEdat)
```
En funciÛ del tipus de metodologies i algoritmes a utilitzar es pot prioritzar l'˙s d'atributs numËrics com en el cas d'**Age** o **TamanyFamilia**, o be, atributs de tipus factor com sÛn **TipusEdat** o **TipusFamilia**, calculats a partir dels camps numËrics. TambÈ s'ha descartat l'˙s del camp **Ticket** per que presenta una estructura bastant variable, no segueix un patrÛ i correspon en gran part a codis de ticket autonumËrics que s'han considerats que aporten poca informaciÛ per a la questiÛ plantejada. El camp **Cabin** tambÈ s'ha descartat perquÈ, si be era un camp que potencialment podria aportar informaciÛ rellevant respecte a la supervivËncia en funciÛ de les cabines, per exemple, degut a la seva ubicaciÛ, el nombre de valors no informats Ès molt elevat (mÈs de 4/5 parts) el que fa poc recomanble el completar els valors no informats mitjanÁant les tËcniques aplicades en altres casos. 
Finalment s'ha utilitzar el camp TamanyFamilia, enlloc dels camps SibSp i Parch, ja que n'Ès l'agrupaciÛ d'ambos, reduint la dimensionalitat del dataset. S'han mantinut els camps **PassengerId** i **Name** per claredat ja que no aporten valor a la identificaciÛ de la supervivËncia.

Per tant el dataset final, integrat i filtrat √©s el seg√ºent :

```{r,message=FALSE}
#dataset final integrat i filtrat 
dades = dades[, !names(dades) %in% c('SibSp','Parch', 'Ticket', 'Cabin', 'TipusFamilia', "TipusEdat")]
summary (dades)
```

El diccionari de dades del dataset final, integrat i filtrat √©s el seg√ºent :

<table border=1>

<th> Variable </th>
<th> Descripci√≥ </th>
<th> Tipus </th>
<th> Valors </th>

<tr>
<td>PassangerId</td>
<td>Identificador de passatger</td>
<td>Enter</td>
<td></td>
</tr>

<tr>
<td>Survival</td>
<td>Identificador de superviv√®ncia</td>
<td>Factor</td>
<td>0 = No, 1 = Yes</td>
</tr>

<tr>
<td>Pclass</td>
<td>Classe del passatge	</td>
<td>Factor</td>
<td>1 = 1a, 2 = 2ona, 3 = 3¬™ </td>
</tr>

<tr>
<td>Name</td>
<td>Nom del passatger</td>
<td>Text</td>
<td></td>
</tr>

<tr>
<td>Sex</td>
<td>Sexe</td>
<td>Factor</td>
<td>1 = male, 2 = female</td>
<td></td>
</tr>
<tr>
<td>Age</td>
<td>Edat en anys</td>
<td>Nombre</td>
<td></td>
</tr>
<tr>
<td>Fare</td>
<td>Tarifa del passatge</td>
<td>Nombre</td>
<td></td>
</tr>
<tr>
<td>Embarked</td>
<td>Port d‚ÄôEmbarcament</td>
<td>Factor</td>
<td>C = Cherbourg 
Q = Queenstown 
S = Southampton</td>
</tr>
<tr>
<td>TamanyFamilia	</td>
<td>Nombre de familiars embarcats	</td>
<td>Enter	</td>
<td>
</tr>
</table>


## 3.2. Identificaci√≥ i tractament de valors extrems.

Identifiquem els valors extrems de les variables **Age** i **Fare** a partir de la funci√≥ boxplot:
```{r,message=FALSE}
outliers_age <- boxplot.stats(dades$Age)$out
outliers_fare <- boxplot.stats(dades$Fare)$out
outliers_age
outliers_fare
```

Si observem els valors extrems identificats de les variables **Age** i **Fare**, s√≥n valors coherents i que no tenen perqu√© suposar un error en la mostra de dades. No obstant, si volguesim eliminar els valors ho fariem mitjan√ßant el codi seg√ºent:

```{r,execute=FALSE}
#dades<-dades[-which(dades$Age %in% outliers_age),]
#dades<-dades[-which(dades$Fare %in% outliers_fare),]
```


#4. An√†lisi de les dades.

##4.1. Selecci√≥ dels grups de dades que es volen analitzar/comparar (planificaci√≥ dels an√†lisis a aplicar).

##4.2. Comprovaci√≥ de la normalitat i homogene√Øtat de la vari√†ncia.

##4.3. Aplicaci√≥ de proves estad√≠stiques per comparar els grups de dades. En funci√≥ de les dades i de l‚Äôobjectiu de l‚Äôestudi, aplicar proves de contrast d‚Äôhip√≤tesis, correlacions, regressions, etc. Aplicar almenys tres m√®todes d‚Äôan√†lisi diferents.

En l'apartat anterior, hem integrat els conjunts d'entrenament i test, aquest fet ens ha estat √∫til per a obtenir una major mostra per omplir amb major confian√ßa els buits o zeros del conjunt. No obstant aix√≤, en aquest apartat ens centrarem en la variable **Survived**. Aquesta variable ens indica si un individuo va sobreviure o no a l'accident del tit√†nic, nom√©s la tenim informada per a les dades del conjunt d'entrenament, per tant, nom√©s utilitzarem les dades d'aquest.

```{r,message=FALSE}
titanic_train <- dades[!is.na(dades$Survived),]
titanic_test <- dades[is.na(dades$Survived),]

write.csv(dades, file = "dadesValidated.csv")
write.csv(titanic_train, file = "trainValidated.csv")
write.csv(titanic_test, file = "testValidated.csv")
```

### Hip√≤tesi nul¬∑la i alternativa

En aquest cas d'estudi, prenem per a hip√≤tesi nul¬∑la que la mitjana de les variables num√®riques **Age, TamanyFamilia, Fare, Pclass** √©s independent a la variable **Survived**. √âs a dir, les mitjanes de les variables anteriors pels passatgers sobrevivents i les que no s√≥n iguals.
$H_0: \mu_1 = \mu_0$

Com a hip√≤tesi alternativa, es t√© que la mitjana de cadascuna de les variables dels passatgers sobrevivents i la dels no sobrevivents √©s diferent.
$H_1: \mu_1 \not= \mu_0$

On $\mu_1$ √©s la mitjana de cadascuna de les variables num√®riques pels passatgers supervivents i $\mu_2$ √©s la mitjana de la variable d'estudi pels passatgers no supervivents.

### Assumpci√≥ de normalitat

Comprovar si es compleix l'assumpci√≥ de normalitat en les dades. Per a fer-ho, s'aplica el test Shapiro-Wilk. Si el p-valor del test Shapiro Wilk √©s superior a 0.05, implica que la distribuci√≥ de les dades no √©s significativament diferent de la distribuci√≥ normal. √âs a dir, podem assumir normalitat.


```{r,message=FALSE}
shapiro.test(titanic_train$Age)
shapiro.test(titanic_train$TamanyFamilia)
shapiro.test(titanic_train$Fare)
shapiro.test(titanic_train$Pclass)
length(titanic_train$Pclass)
```

Com que el p-valor √©s inferior a 0,05 en tots els casos, es rebutja la hip√≤tesi nul¬∑la del test de Shapiro-Wilk que confirma l'assumpci√≥ de normalitat en les dades.

No obstant aix√≤, com que es t√© que $N=891$ com a conseq√º√®ncia del teorema del l√≠mit central, es pot considerar que les dades segueixen una distribuci√≥ normal.

### Homogene√Øtat de la vari√†ncia

Les vari√†ncies s√≥n desconegudes. A continuaci√≥, per a decidir si apliquem vari√†ncies iguals o diferents, apliquem el test de Fligner-Killena.


```{r,message=FALSE}
library(car)

fligner.test(Age ~ Survived, data = titanic_train)
fligner.test(TamanyFamilia ~ Survived, data = titanic_train)
fligner.test(Fare ~ Survived, data = titanic_train)
fligner.test(Pclass ~ Survived, data = titanic_train)
```

El p-valor √©s superior a 0,05 en la variable age i per tant en ella podem assumir la igualtat de vari√†ncies. No obstant aix√≤, per la resta de variables el p-valor √©s inferior a 0,05 i per tant s'assumeix la no igualtat de vari√†ncies.

Per tant, apliquem test t de dues mostres independents per a la difer√®ncia de mitjanes, vari√†ncies desconegudes i iguals en el cas de l'edat i apliquem test de wilcox en el cas de la mida de la fam√≠lia, la tarifa i la classe.

```{r,message=FALSE}
t.test(Age ~ Survived,data = titanic_train, var.equal=TRUE)
wilcox.test(TamanyFamilia ~ Survived,data = titanic_train, var.equal=TRUE)
wilcox.test(Fare ~ Survived,data = titanic_train, var.equal=TRUE)
wilcox.test(Pclass ~ Survived,data = titanic_train, var.equal=TRUE)
```

El valor-p √©s superior a 0,05 en el cas de l'edat i per tant s'accepta la hip√≤tesi $H_0$ i s'afirma que hi ha difer√®ncia estad√≠stica en la mitjana d'edat en els dos grups. A continuaci√≥ es mostren dos histogrames, un amb l'edat dels supervivents i l'altre amb els no supervivents.

```{r, message=FALSE}
hist(dades$Age[dades$Survived == 0], main = "Histograma edat passatgers no supervivents", col = "red")
hist(dades$Age[dades$Survived == 1], main = "Histograma edat passatgers supervivents", col = "blue")
```

En els dos histogrames anteriors, es veu com la majoria de passatgers amb edat inferior a 20 anys van sobreviure al tit√†nic. Pel que fa a les altres franges d'edat, no s'aprecien diferencies.

En canvi, el valor-p √©s inferior a 0,05 en el cas del dimensi√≥ de la fam√≠lia, la tarifa i la classe, per tant es rebutja la hip√≤tesi $H_0$ i s'accepta la hip√≤tesi alternativa $H_1$ que afirmar que no hi ha difer√®ncia estad√≠stica de la mitjana de les dues variables en els dos grups.

### Correlaci√≥

Per a comprovar la correlaci√≥ entre variables, tan sols comparem les variables num√®riques. Per tant, per a aquesta prova seleccionem tan sols les variables **Age**, **TamanyFamilia**, **Fare** i **Pclass**. En primer lloc calculem la matriu de correlaci√≥ entre les variables.


```{r,message=FALSE}
titanic_cor <- data.frame(titanic_train$Age, titanic_train$TamanyFamilia, titanic_train$Fare, titanic_train$Pclass)
cor(titanic_cor)
```

Estudiem doncs els casos amb major correlaci√≥:

-Variables **Pclass** i **Fare**: correlaci√≥ de -0.5598987.
-Variables **Pclass** i **Age**: correlaci√≥ de -0.3543361.
-Variables **Age** i **TamanyFamilia**: correlaci√≥ de -0.3142511.

Abans de comprovar la correlaci√≥ entre els parells de variables anteriors, per a decidir quin √©s el m√®tode m√©s adequat a aplicar, cal comprovar si es compleix l'assumpci√≥ de normalitat en les dades. Per a fer-ho, tal com hem fet anteriorment, s'aplica el test Shapiro-Wilk.

```{r,message=FALSE}
shapiro.test(titanic_train$Pclass)
shapiro.test(titanic_train$Age)
shapiro.test(titanic_train$Fare)
shapiro.test(titanic_train$TamanyFamilia)
```

Com que en tots els casos, el p-valor √©s inferior a 0,05 es rebutja la hip√≤tesi nul¬∑la del test de Shapiro-Wilk  que confirma l'assumpci√≥ de normalitat en les dades. Per tant, per a estudiar la correlaci√≥ entre els parells de variables estudiats aplicarem el test de Spearman.

```{r,message=FALSE}
cor.test(titanic_train$Pclass,titanic_train$Fare, method="spearman")
cor.test(titanic_train$Pclass,titanic_train$Age, method="spearman")
cor.test(titanic_train$TamanyFamilia,titanic_train$Age, method="spearman")
```

En els tres casos, el p-valor √©s significatiu. Per tant, podem observar doncs una correlaci√≥ prou significativa entre les parelles de variables estudiades, m√©s concretament:

-Variables **Pclass** i **Fare**: correlaci√≥ de -0.7284641
-Variables **Pclass** i **Age**: correlaci√≥ de -0.3433576
-Variables **Age** i **TamanyFamilia**: correlaci√≥ de -0.2299892

La primera resulta totalment comprensible ja que la tarifa sol anar marcada principalment per a la classe, on la primera √©s la que t√© tarifa m√©s alta i la tercera la m√©s baixa, √©s a dir correlaci√≥ negativa.

El segon resultat tamb√© sembla coherent, ja que com m√©s edat t√© una persona, normalment acostuma a tenir major poder adquisitiu i m√©s comoditat busca, per tant, selecciona classes superiors.

Les variables **Age** i **TamanyFamilia** tenen una petita correlaci√≥ negativa que tamb√© t√© una possible explicaci√≥, ja que per exemple els nens, no viatjaran sols. En canvi, els adults s√≠ que podrien viatjar sols. Finalment, observem els diagrames de dispersi√≥ de les 3 parelles anteriors.

```{r, message=FALSE}
plot(titanic_train$Fare, titanic_train$Pclass, main="Diagrama dispersi√≥ Pclass i Fare")
plot(titanic_train$Age, titanic_train$Pclass, main="Diagrama dispersi√≥ Pclass i Age")
plot(titanic_train$Age, titanic_train$TamanyFamilia, main="Diagrama dispersi√≥ Age i TamanyFamilia")
```

### Regressi√≥ log√≠stica

En el nostre cas, el conjunt d'entrenament i de test ja venen definits per necesitat, ja que en aquest segon no hi ha la categoritzaci√≥ de si un passatger a sobreviscut o no. En cas que no hi hagu√©s un conjunt d'entrenament definit i per a guanyar una major eficiencia en l'algoritme predictiu, una bona estrategia seria dividir de diferents maneres els conjunts d'entrenament i test, comparant mitjanes o desviacions tipiques per tal d'aconseguir un model mes robust. Una tecnica molt comuna que permet crear diferents conjunts d'entrenaments i tests per tal d'optimitzar el model √©s el K-Fold.

En primer lloc cal tractar les variables categ√≤riques. Usant el que s‚Äôanomena variables dummy podrem calcular el model lineal. Per a fer-ho, especificarem quina √©s la categoria de refer√®ncia amb la funci√≥ relevel(). En la variable **Sex**, la categoria de refer√®ncia √©s ‚Äúfemale‚Äù i per a la variable **Embarked** la categoria de refer√®ncia √©s "S"

```{r, message=FALSE}
titanic_train$sexR <- relevel(titanic_train$Sex, ref = "female")
titanic_train$EmbarkedR <- relevel(titanic_train$Embarked, ref = "S")
```

Apliquem diversos models de regressi√≥ log√≠stica combinant diferents variables del conjunt de dades per a buscar el millor model de regressi√≥.

```{r, message=FALSE}
model1<- glm(Survived ~ sexR+TamanyFamilia+Age+EmbarkedR+Pclass,data=titanic_train)
summary(model1)
model2<- glm(Survived ~ sexR+Age+Pclass,data=titanic_train)
summary(model2)
model3<- glm(Survived ~ sexR+EmbarkedR+Pclass,data=titanic_train)
summary(model3)
model4<- glm(Survived ~ sexR+TamanyFamilia+Pclass,data=titanic_train)
summary(model4)
model5<- glm(Survived ~ sexR+Age,data=titanic_train)
summary(model5)

```

Dels models anteriors (i tots els provats) seleccionem el **model1**, ja que √©s el model que t√© major bondat per a tenir una menor AIC. A partir d'aquest model predim la probabilitat de sobreviure de cadasc√∫n dels registres del conjunt de test:

```{r, message=FALSE}
titanic_test$sexR <- relevel(titanic_test$Sex, ref = "female")
titanic_test$EmbarkedR <- relevel(titanic_test$Embarked, ref = "S")

titanic_test$ProbSurvived <- predict(model1, titanic_test)
```

Mostrem la taula que cont√© el resultat de les prediccions del conjunt de test:

```{r, message=FALSE}
library(kableExtra)
kable(head(titanic_test), format = 'markdown')

write.csv(titanic_test, file = "testPrediction.csv")
```

# 5. Representaci√≥ dels resultats a partir de taules i gr√†fiques.

Al llarg d'aquesta pr√†ctica s'han mostrat diferents gr√†fiques o taules per a mostrar els resultats.

# 6. Resoluci√≥ del problema. A partir dels resultats obtinguts, quines s√≥n les conclusions? Els resultats permeten respondre al problema?

# 6.1.- ProcÈs de neteja i validaciÛ
 
Es partia de dos conjunts de dades relatives als passatgers del Titanic. Un conjunt de training (on síinformava el camp Survived) i un conjunt de test (on no síinformava el camp Survived). El dataset síutilitza per generar models de predicciÛ de la probabilitat de supervivËncia en funciÛ de les caracterÌstiques del passatger. Per a la fase de neteja i validaciÛ de les dades síha optat per integrar els dos fitxers per disposar de mÈs registres que permetessin aplicar tËcniques per completar camps no informats amb major precisiÛ. Díuna an‡lisi preliminar síha comprovat que el conjunt de dades presentava nombrosos camps no informats (en especial el camp Age). Síha procedit a analitzar aquests camps i aplicar diverses tËcniques per completar-los.

El camp Fare (Tarifa) presentava un valor no informat. Per deduir-lo síhan obtingut tots els registres que compartien classe i origen díembarcament, síha obtingut la mitja i síha assignat al valor no informat.

Per al camp Embarket (Origen díembarcament) , síhan obtingut els registres no informats i síobserva que tots ells comparteixen tarifa i classe. Síha obtingut la mitjana de la tarifa pels passatgers de classe 1 per cada port díorigen i síha assignat el port origen que tenia una tarifa mitjana mÈs propera.

En el cas del camp Age, donat que hi havia molts camps no informats i era important conservar-los, síha optat per aplicar la metodologia Mice (Multivariate Imputations by Chained Equations).

Finalment pel camp Fare, síhan substituÔt els valors 0 per valors no informats (per requeriment de líalgoritme kNN) i síha utilitzat líalgoritme kNN per estimar-los.

Síhan creat camps nous com TamanyFamilia que Ès la agrupaciÛ dels camps SibSp i  Parch, el que ha permËs reduir la dimensiÛ del dataset i síhan generat els camps factor TipusFamilia i TipusEdat per si eren interessants per líaplicaciÛ de certs mËtodes.

El dataset final esta format pels camps PassangerId, Survival, Pclass, Name, Sex , Age, Fare, Embarked i TamanyFamilia.

# 6.2.- An√†lisi de dades

Fent l'an√†lisi de dades hem arribat a la conclusi√≥, mitjan√ßant tests d'hip√≤tesis, que en general els passatgers del tit√†nic menor de vint anys tenien un major √≠ndex de superviv√®ncia. Mitjan√ßant aquesta mateixa prova hem vist que ni per la mida de la fam√≠lia, ni per la tarifa, ni per la classe en la qual es viatjava, s'aprecien diferencies en l'√≠ndex de superviv√®ncia.

Aplicant un test de correlaci√≥, hem detectat correlaci√≥ negativa entre el preu del bitllet i la classe que es viatja, l'edat del passatger i la classe en la qual viatge o b√© l'edat del passatger i el nombre de familiars a bord.

Finalment i mitjan√ßant un algoritme de regressi√≥ logistica, hem escollit un model entre els diferents que hem creat que ens a perm√©s predir la probabilitat de supervivencia dels individuos del conjunt de test.


<table border=1>
<th> Contribucions </th>
<th> Firma </th>

<tr>
<td>Investigaci√≥ pr√®via</td>
<td>PC CR</td>
</tr>

<tr>
<td>Redacci√≥ de les respostes</td>
<td>PC CR</td>
</tr>

<tr>
<td>Desenvolupament codi</td>
<td>PC CR</td>
</tr>
</table>

